From a99de464ef79773011c8b14977aa20c4409d0f09 Mon Sep 17 00:00:00 2001
From: Joshua Strobl <joshua@streambits.io>
Date: Thu, 5 Nov 2020 23:12:57 +0200
Subject: [PATCH 19/20] Implement AppMenu toggling.

In our previous GNOME Stack release, I opted to completely remove the AppMenu. This was done as there was clear indications at the time that it was planned to be deprecated or removed, given the respective functionality was being moved out of AppMenu across multiple GNOME applications and into the Headerbar menus. Unfortunately, either such deprecation hasn't come to fruition yet, there was mixed messaging by GNOME, or such plans are no longer moving forward.

As such, I've opted to implement a setting to enable the toggling on of AppMenu functionality. This is really only done to allow for Solus GNOME users to enable and utilize third-party extensions that otherwise leverage the AppMenu, otherwise I would just permanently remove the functionality given it provides no real user value otherwise (in my opinion).
---
 data/org.gnome.shell.gschema.xml.in |  7 +++++++
 js/ui/panel.js                      | 30 +++++++++++++++++++++++++----
 js/ui/popupMenu.js                  |  6 ++++++
 3 files changed, 39 insertions(+), 4 deletions(-)

diff --git a/data/org.gnome.shell.gschema.xml.in b/data/org.gnome.shell.gschema.xml.in
index 6eacfa568..dca3d79ea 100644
--- a/data/org.gnome.shell.gschema.xml.in
+++ b/data/org.gnome.shell.gschema.xml.in
@@ -32,6 +32,13 @@
         This key takes precedence over the “enabled-extensions” setting.
       </description>
     </key>
+    <key name="show-app-menu" type="b">
+        <default>false</default>
+        <summary>Show AppMenu</summary>
+        <description>
+            Shows the AppMenu with the current window information. Must be enabled for use by third-party AppMenu extensions.
+        </description>
+    </key>
     <key name="disable-user-extensions" type="b">
       <default>false</default>
       <summary>Disable user extensions</summary>
diff --git a/js/ui/panel.js b/js/ui/panel.js
index 272368a4b..939a3389e 100644
--- a/js/ui/panel.js
+++ b/js/ui/panel.js
@@ -15,6 +15,7 @@ const Main = imports.ui.main;
 
 var PANEL_ICON_SIZE = 16;
 var APP_MENU_ICON_MARGIN = 0;
+const SHOW_APP_MENU = 'show-app-menu';
 
 var BUTTON_DND_ACTIVATION_TIMEOUT = 250;
 
@@ -244,9 +245,9 @@ var AppMenuButton = GObject.registerClass({
         });
         this._container.add_actor(this._spinner);
 
-        let menu = new AppMenu(this);
-        this.setMenu(menu);
-        this._menuManager.addMenu(menu);
+        this._appmenu = new AppMenu(this);
+        this.setMenu(this._appmenu);
+        this._menuManager.addMenu(this._appmenu);
 
         let tracker = Shell.WindowTracker.get_default();
         let appSys = Shell.AppSystem.get_default();
@@ -258,6 +259,8 @@ var AppMenuButton = GObject.registerClass({
             global.window_manager.connect('switch-workspace', this._sync.bind(this));
 
         this._sync();
+        global.settings.connect(`changed::${SHOW_APP_MENU}`, () => this._updateVisibility()); // Connect to our show-app-menu setting
+        this._updateVisibility(); // Do our initial trigger for AppMenu visibility
     }
 
     fadeIn() {
@@ -356,6 +359,10 @@ var AppMenuButton = GObject.registerClass({
     }
 
     _sync() {
+        if (!global.settings.get_boolean(SHOW_APP_MENU)) {
+            return;
+        }
+
         let targetApp = this._findTargetApp();
 
         if (this._targetApp != targetApp) {
@@ -394,6 +401,16 @@ var AppMenuButton = GObject.registerClass({
         this.emit('changed');
     }
 
+    _updateVisibility() {
+        if (global.settings.get_boolean(SHOW_APP_MENU)) { // If we should show it
+            this.show();
+        } else { // If we should hide it
+            this.hide();
+        }
+
+        this.emit('changed');
+    }
+
     _onDestroy() {
         if (this._appStateChangedSignalId > 0) {
             let appSys = Shell.AppSystem.get_default();
@@ -985,7 +1002,12 @@ class Panel extends St.Widget {
     }
 
     toggleAppMenu() {
-        this._toggleMenu(this.statusArea.appMenu);
+        let show = global.settings.get_boolean(SHOW_APP_MENU); // Get the current value
+        if (show) {
+            this._toggleMenu(this.statusArea.appMenu);
+        } else {
+            this.hide();
+        }
     }
 
     toggleCalendar() {
diff --git a/js/ui/popupMenu.js b/js/ui/popupMenu.js
index a618f8fb4..6a667f992 100644
--- a/js/ui/popupMenu.js
+++ b/js/ui/popupMenu.js
@@ -1324,6 +1324,12 @@ var PopupMenuManager = class {
     }
 
     removeMenu(menu) {
+        if (menu == undefined)
+            return;
+
+        if (this.activeMenu == undefined)
+            return;
+
         if (menu == this.activeMenu)
             this._grabHelper.ungrab({ actor: menu.actor });
 
-- 
2.29.1

